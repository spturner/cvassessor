<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV Assessment App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- PDF.js library for reading PDF files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .traffic-light {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            transition: background-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }
        .traffic-light-red { background-color: #f87171; box-shadow: 0 0 15px #f87171; }
        .traffic-light-amber { background-color: #fbbf24; box-shadow: 0 0 15px #fbbf24; }
        .traffic-light-green { background-color: #4ade80; box-shadow: 0 0 15px #4ade80; }
        .traffic-light-gray { background-color: #d1d5db; }
        
        /* Highlight and Tooltip styles */
        .highlight-layer {
            position: absolute;
            background-color: rgba(254, 240, 138, 0.5); /* Semi-transparent yellow */
            border-radius: 2px;
            cursor: pointer;
            transition: background-color 0.2s;
            z-index: 5; /* Ensure it's above the canvas */
        }
        .highlight-layer:hover {
            background-color: rgba(253, 224, 71, 0.7);
        }

        .highlight-layer .tooltip-text {
            visibility: hidden;
            width: 220px;
            background-color: #27272a; /* Dark background */
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 10;
            bottom: 115%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
            line-height: 1.4;
        }

        .highlight-layer .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #27272a transparent transparent transparent;
        }

        .highlight-layer:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">AI-Powered CV Assistant</h1>
            <p class="text-lg text-gray-600 mt-2">Upload your CV and let Gemini provide expert feedback to improve it.</p>
        </header>

        <div class="bg-white p-6 rounded-xl shadow-lg w-full">
            <!-- Top Controls -->
            <div class="space-y-4 mb-6 pb-6 border-b border-gray-200">
                <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                    <div class="flex items-center space-x-4">
                        <label for="file-input" class="cursor-pointer bg-blue-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-blue-700 transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300 whitespace-nowrap">
                            1. Upload CV
                        </label>
                        <p id="file-name" class="text-sm font-medium text-gray-600"></p>
                    </div>
                     <button id="assess-btn" class="w-full sm:w-auto bg-green-600 text-white font-bold py-2 px-8 rounded-lg hover:bg-green-700 transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-300 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:transform-none" disabled>
                        Assess My CV
                    </button>
                </div>
                 <div class="w-full">
                    <label for="api-key-input" class="flex items-center text-sm font-bold text-gray-700 mb-1">
                        <span>2. Enter Your Gemini API Key</span>
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" class="ml-2 text-blue-600 hover:underline">(Get a key here)</a>
                    </label>
                    <input type="password" id="api-key-input" placeholder="Paste your API key here to enable assessment" class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
             <input type="file" id="file-input" class="hidden" accept=".pdf">
            
            <!-- Assessment Output Section -->
            <div id="assessment-output">
                <!-- Initial State -->
                <div id="initial-state" class="text-center py-20 text-gray-500">
                    <svg class="mx-auto h-16 w-16 text-gray-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <h3 class="mt-2 text-xl font-medium">Ready for Analysis</h3>
                    <p class="mt-1 text-sm">Please upload a CV and enter your API key to begin.</p>
                </div>
                
                <!-- Loading Spinner -->
                <div id="loading-spinner" class="text-center py-20 hidden">
                    <svg class="animate-spin h-10 w-10 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-4 text-gray-600">Gemini is analyzing your CV...</p>
                </div>
                
                <!-- Results Content -->
                <div id="results-content" class="hidden">
                    <div class="flex flex-col md:flex-row items-center justify-between bg-gray-50 p-4 rounded-lg mb-6">
                        <div class="text-center md:text-left">
                            <p class="text-sm text-gray-500">ATS Friendliness</p>
                            <h3 id="traffic-light-text" class="text-2xl font-bold">Awaiting Analysis</h3>
                        </div>
                        <div id="traffic-light" class="traffic-light traffic-light-gray mt-4 md:mt-0"></div>
                        <div class="text-center md:text-right mt-4 md:mt-0">
                             <p class="text-sm text-gray-500">Overall Score</p>
                            <h3 id="cv-score" class="text-3xl font-bold">0/100</h3>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div class="mb-4 border-b border-gray-200">
                        <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                            <button onclick="changeTab('reviewed')" id="tab-reviewed" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-blue-600 border-blue-600">
                                Reviewed CV
                            </button>
                            <button onclick="changeTab('suggestions')" id="tab-suggestions" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300">
                                Key Suggestions
                            </button>
                        </nav>
                    </div>

                    <!-- Tab Content -->
                    <div id="content-reviewed" class="tab-content">
                        <h3 class="text-lg font-semibold mb-2">Highlighted CV <span class="text-sm font-normal text-gray-500">(Hover over highlights for details)</span></h3>
                        <div id="highlighted-cv" class="w-full border border-gray-200 rounded-lg p-4 overflow-auto bg-gray-50"></div>
                    </div>
                    <div id="content-suggestions" class="tab-content hidden">
                        <h3 class="text-lg font-semibold mb-2">High-Priority Feedback</h3>
                        <ul id="suggestions-list" class="list-disc list-inside space-y-2 text-sm">
                            <!-- Suggestions will be populated by JS -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <textarea id="cv-input" class="hidden"></textarea> <!-- Keep hidden textarea for extracted text -->

    <script>
        const assessBtn = document.getElementById('assess-btn');
        const cvInput = document.getElementById('cv-input');
        const apiKeyInput = document.getElementById('api-key-input');
        const assessmentOutput = document.getElementById('assessment-output');
        const initialState = document.getElementById('initial-state');
        const loadingSpinner = document.getElementById('loading-spinner');
        const resultsContent = document.getElementById('results-content');
        const cvScoreEl = document.getElementById('cv-score');
        const trafficLightEl = document.getElementById('traffic-light');
        const trafficLightTextEl = document.getElementById('traffic-light-text');
        const highlightedCvEl = document.getElementById('highlighted-cv');
        const suggestionsListEl = document.getElementById('suggestions-list');
        const fileInput = document.getElementById('file-input');
        const fileNameEl = document.getElementById('file-name');
        
        let pdfDoc = null; 

        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;
        
        function checkReadyState() {
            const apiKey = apiKeyInput.value.trim();
            const fileLoaded = pdfDoc !== null;
            assessBtn.disabled = !(apiKey && fileLoaded);
        }

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleFile(e.target.files[0]);
        });
        apiKeyInput.addEventListener('input', checkReadyState);
        
        function handleFile(file) {
            if (file.type !== 'application/pdf') {
                alert('Please upload a PDF file.');
                return;
            }
            pdfDoc = null;
            checkReadyState();
            fileNameEl.textContent = `Processing: ${file.name}`;

            const reader = new FileReader();
            reader.onload = function(event) {
                const pdfData = new Uint8Array(event.target.result);
                pdfjsLib.getDocument({ data: pdfData }).promise.then(doc => {
                    pdfDoc = doc; 
                    const pagePromises = Array.from({length: doc.numPages}, (_, i) => 
                        doc.getPage(i + 1).then(page => 
                            page.getTextContent().then(textContent => 
                                textContent.items.map(item => item.str).join(' ')
                            )
                        )
                    );
                    Promise.all(pagePromises).then(pagesText => {
                        cvInput.value = pagesText.join('\n\n');
                        fileNameEl.textContent = `${file.name}`;
                        checkReadyState();
                    });
                }).catch(err => {
                    console.error('Error parsing PDF:', err);
                    fileNameEl.textContent = `Error reading file.`;
                });
            };
            reader.readAsArrayBuffer(file);
        }

        function changeTab(tabName) {
            document.getElementById('content-reviewed').classList.toggle('hidden', tabName !== 'reviewed');
            document.getElementById('content-suggestions').classList.toggle('hidden', tabName !== 'suggestions');
            const tabReviewed = document.getElementById('tab-reviewed');
            const tabSuggestions = document.getElementById('tab-suggestions');
            tabReviewed.classList.toggle('text-blue-600', tabName === 'reviewed');
            tabReviewed.classList.toggle('border-blue-600', tabName === 'reviewed');
            tabReviewed.classList.toggle('text-gray-500', tabName !== 'reviewed');
            tabReviewed.classList.toggle('border-transparent', tabName !== 'reviewed');
            tabSuggestions.classList.toggle('text-blue-600', tabName === 'suggestions');
            tabSuggestions.classList.toggle('border-blue-600', tabName === 'suggestions');
            tabSuggestions.classList.toggle('text-gray-500', tabName !== 'suggestions');
            tabSuggestions.classList.toggle('border-transparent', tabName !== 'suggestions');
        }

        assessBtn.addEventListener('click', async () => {
            const cvText = cvInput.value;
            const apiKey = apiKeyInput.value.trim();

            if (!apiKey) {
                alert("Please enter your Gemini API key.");
                return;
            }
            if (cvText.trim().length < 50) {
                alert("Extracted text is too short. Please try another file.");
                return;
            }
            initialState.classList.add('hidden');
            resultsContent.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');
            changeTab('reviewed');

            try {
                const assessment = await analyzeCVWithGemini(cvText, apiKey);
                if (assessment) {
                    displayResults(assessment);
                    renderAndHighlightCV(pdfDoc, assessment);
                } else {
                    alert("Analysis failed. Please try again. Check the console for API errors.");
                }
            } catch (error) {
                console.error("Error during Gemini analysis:", error);
                alert("An error occurred while analyzing the CV. Please check the console for details.");
            } finally {
                loadingSpinner.classList.add('hidden');
                resultsContent.classList.remove('hidden');
            }
        });
        
        async function analyzeCVWithGemini(text, apiKey) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const systemPrompt = "You are an expert career coach and CV analyst. Your task is to review the provided CV text and return a structured JSON object with your analysis. Do not include any introductory text or markdown formatting in your response.";
            
            const userQuery = `Please analyze the following CV text. Identify personal pronouns, buzzwords, weasel words, and any achievement statements starting with strong action verbs that are not quantified with numbers. Also, check if an email and phone number are present. Provide a score out of 100 and a list of actionable suggestions. CV Text: """${text}"""`;

            const schema = {
                type: "OBJECT",
                properties: {
                    score: { type: "NUMBER", description: "Overall CV score from 0 to 100." },
                    suggestions: { type: "ARRAY", items: { type: "STRING" }, description: "Actionable suggestions for improvement." },
                    issues: {
                        type: "OBJECT",
                        properties: {
                            pronouns: { type: "ARRAY", items: { "type": "STRING" }, description: "List of personal pronouns found." },
                            buzzwords: { type: "ARRAY", items: { "type": "STRING" }, description: "List of buzzwords or clichés found." },
                            weaselWords: { type: "ARRAY", items: { "type": "STRING" }, description: "List of weak 'weasel words' found." },
                            unquantifiedAchievements: { type: "ARRAY", items: { "type": "STRING" }, description: "Action verbs from unquantified achievements." }
                        }
                    },
                    isEmailMissing: { type: "BOOLEAN", description: "True if an email address is not found." },
                    isPhoneMissing: { type: "BOOLEAN", description: "True if a phone number is not found." }
                },
                required: ["score", "suggestions", "issues", "isEmailMissing", "isPhoneMissing"]
            };

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: schema
                }
            };
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                console.error("API Error:", response.status, await response.text());
                return null;
            }

            const result = await response.json();
            const candidate = result.candidates?.[0];
            const jsonText = candidate?.content?.parts?.[0]?.text;
            
            if (jsonText) {
                return JSON.parse(jsonText);
            }
            return null;
        }


        async function renderAndHighlightCV(pdfDoc, assessment) {
            highlightedCvEl.innerHTML = '';
            const { issues, isEmailMissing, isPhoneMissing } = assessment;

            const highlightRules = [];
            if (issues.pronouns?.length) {
                highlightRules.push({
                    regex: new RegExp(`\\b(${issues.pronouns.join('|')})\\b`, 'i'),
                    reason: "Personal pronoun found. Use action verbs to start sentences instead."
                });
            }
            if (issues.buzzwords?.length) {
                highlightRules.push({
                    regex: new RegExp(`\\b(${issues.buzzwords.join('|')})\\b`, 'i'),
                    reason: "This is a cliché. Show, don't just tell, this quality with examples."
                });
            }
            if (issues.weaselWords?.length) {
                 highlightRules.push({
                    regex: new RegExp(`\\b(${issues.weaselWords.join('|')})\\b`, 'i'),
                    reason: "This is a 'weasel word'. Use a stronger verb to describe what you did."
                });
            }
             if (issues.unquantifiedAchievements?.length) {
                 highlightRules.push({
                    regex: new RegExp(`\\b(${issues.unquantifiedAchievements.join('|')})\\b`, 'i'),
                    reason: "This achievement is not quantified. Add a number, $, or % to show impact."
                });
            }

            for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
                const page = await pdfDoc.getPage(pageNum);
                const scale = 1.5;
                const viewport = page.getViewport({ scale });
                
                const canvasContainer = document.createElement('div');
                canvasContainer.className = 'relative mx-auto mb-4 shadow-lg';
                canvasContainer.style.width = `${viewport.width}px`;
                canvasContainer.style.height = `${viewport.height}px`;

                const canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                const context = canvas.getContext('2d');
                
                canvasContainer.appendChild(canvas);
                highlightedCvEl.appendChild(canvasContainer);
                
                await page.render({ canvasContext: context, viewport }).promise;
                
                const textContent = await page.getTextContent();
                
                textContent.items.forEach(item => {
                    const text = item.str;
                    if (!text.trim()) return;

                    for (const rule of highlightRules) {
                        if (rule.regex.test(text)) {
                            const defaultTransform = viewport.transform;
                            const transform = pdfjsLib.Util.transform(defaultTransform, item.transform);
                            
                            const highlightDiv = document.createElement('div');
                            highlightDiv.className = 'highlight-layer';
                            highlightDiv.style.left = `${transform[4]}px`;
                            highlightDiv.style.top = `${transform[5] - item.height * scale}px`;
                            highlightDiv.style.width = `${item.width * scale}px`;
                            highlightDiv.style.height = `${item.height * scale}px`;

                            const tooltip = document.createElement('span');
                            tooltip.className = 'tooltip-text';
                            tooltip.textContent = rule.reason;
                            highlightDiv.appendChild(tooltip);
                            canvasContainer.appendChild(highlightDiv);
                            break; 
                        }
                    }
                });

                if (pageNum === 1 && (isEmailMissing || isPhoneMissing)) {
                    const headerHeight = viewport.height * 0.20; 
                    const textInHeader = textContent.items.some(item => {
                        const transform = pdfjsLib.Util.transform(viewport.transform, item.transform);
                        return transform[5] < headerHeight;
                    });

                    if(textInHeader){
                        let missingItems = [];
                        if (isEmailMissing) missingItems.push("email");
                        if (isPhoneMissing) missingItems.push("phone number");
                        const reason = `Contact info seems to be missing. Ensure your ${missingItems.join(' and ')} is clearly visible in the header.`;

                        const highlightDiv = document.createElement('div');
                        highlightDiv.className = 'highlight-layer';
                        highlightDiv.style.left = `20px`;
                        highlightDiv.style.top = `20px`;
                        highlightDiv.style.width = `${viewport.width - 40}px`;
                        highlightDiv.style.height = `${headerHeight - 20}px`;
                        highlightDiv.style.backgroundColor = 'rgba(251, 191, 36, 0.4)';

                        const tooltip = document.createElement('span');
                        tooltip.className = 'tooltip-text';
                        tooltip.textContent = reason;
                        highlightDiv.appendChild(tooltip);
                        canvasContainer.appendChild(highlightDiv);
                    }
                }
            }
        }

        function displayResults(assessment) {
            cvScoreEl.textContent = `${assessment.score}/100`;

            trafficLightEl.className = 'traffic-light'; // reset
            const colors = { green: '#22c55e', amber: '#f59e0b', red: '#ef4444' };
            if (assessment.score >= 75) {
                trafficLightEl.classList.add('traffic-light-green');
                trafficLightTextEl.textContent = 'Good';
                trafficLightTextEl.style.color = colors.green;
            } else if (assessment.score >= 45) {
                trafficLightEl.classList.add('traffic-light-amber');
                trafficLightTextEl.textContent = 'Needs Improvement';
                trafficLightTextEl.style.color = colors.amber;
            } else {
                trafficLightEl.classList.add('traffic-light-red');
                trafficLightTextEl.textContent = 'High Concern';
                trafficLightTextEl.style.color = colors.red;
            }

            suggestionsListEl.innerHTML = '';
            if (assessment.suggestions.length === 0) {
                 suggestionsListEl.innerHTML = '<li><p class="font-semibold">Excellent!</p><p>Your CV looks strong and ATS-friendly. No major issues were found.</p></li>';
            } else {
                assessment.suggestions.forEach(suggestion => {
                    const li = document.createElement('li');
                    li.textContent = suggestion;
                    suggestionsListEl.appendChild(li);
                });
            }
        }
    </script>

</body>
</html>

